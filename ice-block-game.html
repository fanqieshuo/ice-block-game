<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å†°å—æ¸¸æˆæ¼”ç¤º</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="shortcut icon" href="icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="å†°å—æ¸¸æˆ">
  <meta name="application-name" content="å†°å—æ¸¸æˆ">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileImage" content="icons/icon-192x192.png">
  <meta name="msapplication-TileColor" content="#aeefff">
  <meta name="theme-color" content="#aeefff">
  <style>
    body {
      background: #f5f7fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', 'PingFang SC', Arial, sans-serif;
      touch-action: manipulation;
    }
    h1 {
      margin-bottom: 16px;
      color: #3a3a3a;
    }
    .game-board {
      display: grid;
      grid-template-columns: repeat(4, 80px);
      grid-template-rows: repeat(3, 80px);
      gap: 16px;
      background: #e0e0e0;
      padding: 24px;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(80,120,200,0.10);
      margin-bottom: 24px;
      position: relative;
    }
    .cell {
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      perspective: 200px;
    }
    .ice-block {
      width: 68px;
      height: 68px;
      background: linear-gradient(145deg, #e6f7ff 60%, #aeefff 100%);
      border-radius: 12px;
      box-shadow: 0 4px 12px #b3e0ff, 0 2px 0 #b3e0ff inset, 0 0 0 2px #b3e0ff inset;
      border: 2px solid #aeefff;
      transition: transform 0.2s, background 0.3s, box-shadow 0.3s;
      position: relative;
      cursor: grab;
      user-select: none;
      touch-action: none;
    }
    .ice-block.dragging {
      cursor: grabbing;
      transform: scale(1.05);
      z-index: 100;
    }
    .ice-block.moved {
      background: linear-gradient(145deg, #ff8fa8 60%, #ff0044 100%);
      box-shadow: 0 4px 12px #ff0044, 0 2px 0 #ff0044 inset, 0 0 0 2px #ff0044 inset;
      border: 2px solid #ff0044;
      animation: pulse 1s ease-in-out;
    }
    .ice-block::after {
      content: '';
      display: block;
      position: absolute;
      left: 10px; right: 10px; top: 10px; bottom: 10px;
      border-radius: 8px;
      background: linear-gradient(120deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.1) 100%);
      pointer-events: none;
    }
    .empty {
      width: 68px;
      height: 68px;
      background: linear-gradient(145deg, #f0f0f0 60%, #e0e0e0 100%);
      border-radius: 12px;
      box-shadow: 0 2px 8px #cccccc;
      border: 2px dashed #cccccc;
    }
    .original-position {
      width: 68px;
      height: 68px;
      background: linear-gradient(145deg, #666666 60%, #555555 100%);
      border-radius: 12px;
      box-shadow: 0 2px 8px #444444;
      border: 2px dashed #555555;
    }
    .win-message {
      color: #6c4fd1;
      font-size: 1.3em;
      margin-top: 10px;
      font-weight: bold;
      letter-spacing: 2px;
      background: #f3e6ff;
      padding: 10px 24px;
      border-radius: 8px;
      box-shadow: 0 2px 8px #d1b3ff33;
      display: none;
    }
    .restart-btn {
      background: #aeefff;
      color: #3a3a3a;
      border: none;
      border-radius: 8px;
      padding: 8px 24px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px #b3e0ff44;
      margin-top: 18px;
      transition: background 0.2s;
    }
    .restart-btn:hover {
      background: #d1b3ff;
      color: #fff;
    }
    .instructions {
      color: #666;
      margin-bottom: 20px;
      font-size: 0.9em;
      text-align: center;
    }
    .game-stats {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      margin-bottom: 15px;
    }
    .stat-box {
      background: #ffffff;
      padding: 5px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-label {
      font-size: 0.9em;
      color: #666;
    }
    .stat-value {
      font-size: 1.5em;
      font-weight: bold;
      color: #3a3a3a;
    }
    /* å¼¹çª—æ ·å¼ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 80%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      transform: scale(0.8);
      transition: transform 0.3s;
    }
    .modal-overlay.active .modal-content {
      transform: scale(1);
    }
    .modal-title {
      font-size: 1.8em;
      color: #6c4fd1;
      margin-bottom: 10px;
    }
    .modal-message {
      font-size: 1.3em;
      margin-bottom: 20px;
      color: #3a3a3a;
    }
    .modal-button {
      background: #d1b3ff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 24px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: background 0.2s;
    }
    .modal-button:hover {
      background: #6c4fd1;
    }
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #d1b3ff;
      border-radius: 50%;
      opacity: 0.8;
      animation: fall 3s ease-in-out infinite;
    }
    @keyframes fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    @media (max-width: 600px) {
      .game-board {
        grid-template-columns: repeat(4, 48px);
        grid-template-rows: repeat(3, 48px);
        gap: 8px;
        padding: 8px;
      }
      .cell, .ice-block, .empty, .original-position {
        width: 48px !important;
        height: 48px !important;
      }
    }
    .highlight-possible {
      box-shadow: 0 0 0 3px #aeefff, 0 0 12px 5px rgba(0, 200, 255, 0.5) !important;
    }
    .possible-target {
      position: relative;
    }
    /* æ·»åŠ æ»‘è¡Œè½¨è¿¹åŠ¨ç”» */
    @keyframes slide-effect {
      0% { 
        transform: scale(1); 
        opacity: 1;
      }
      100% { 
        transform: scale(0.8); 
        opacity: 0.2;
      }
    }
    .slide-trace {
      position: absolute;
      width: 60%;
      height: 60%;
      background-color: rgba(174, 239, 255, 0.5);
      border-radius: 12px;
      z-index: 0;
      animation: slide-effect 0.5s ease-out forwards;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <h1>å†°å—æ¸¸æˆ</h1>
  <p class="instructions">è¯·æ‹–åŠ¨å†°å—åˆ°ç°è‰²ç©ºä½ã€‚æ¯ä¸ªå†°å—åªèƒ½ç§»åŠ¨1æ¬¡ï¼Œå·²ç§»åŠ¨çš„å†°å—ï¼ˆç²‰çº¢è‰²ï¼‰åªèƒ½é€€å›åŸä½ç½®ã€‚å†°å—å¯ä»¥è·¨è¿‡å…¶ä»–å†°å—æˆ–ç©ºä½ç§»åŠ¨ã€‚</p>
  
  <div class="game-stats">
    <div class="stat-box">
      <div class="stat-label">ç§»åŠ¨æ­¥æ•°</div>
      <div class="stat-value" id="move-counter">0</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">å†°å—æ•°é‡</div>
      <div class="stat-value" id="ice-counter">6</div>
    </div>
  </div>
  
  <div class="game-board" id="game-board"></div>
  <div class="win-message" id="win-message">ğŸ‰ æ­å–œä½ ï¼Œå…¨éƒ¨å†°å—å·²å½’ä½ï¼</div>
  <button class="restart-btn" id="restart-btn">é‡æ–°å¼€å§‹</button>
  
  <!-- èƒœåˆ©å¼¹çª— -->
  <div class="modal-overlay" id="win-modal">
    <div class="modal-content">
      <div class="modal-title">æ¸¸æˆèƒœåˆ©ï¼</div>
      <div class="modal-message" id="win-steps-message">ä½ å¤ªæ£’äº†ï¼Œä½ åªç”¨äº†0æ­¥ï¼</div>
      <button class="modal-button" id="modal-restart-btn">å†æ¥ä¸€å±€</button>
    </div>
  </div>
  
  <script>
    // é…ç½®
    const ROWS = 3;
    const COLS = 4;
    const ICE_COUNT = 6; // å†°å—æ•°é‡ 6-8ä¸ª

    // æ¸¸æˆçŠ¶æ€
    let board = [];        // 0: ç©ºä½, 1: å†°å—, 2: åŸå§‹ä½ç½®(å·²ç§»èµ°å†°å—)
    let originalPositions = []; // è®°å½•åŸå§‹å†°å—ä½ç½®
    let iceBlocksOriginalPos = []; // è®°å½•æ¯ä¸ªå†°å—çš„åŸå§‹ä½ç½® {r, c, idx}
    let moved = [];        // è®°å½•å“ªäº›å†°å—å·²è¢«ç§»åŠ¨
    let moveCount = 0;     // ç§»åŠ¨æ­¥æ•°
    
    let draggedIce = null;
    let dragStartPos = { r: -1, c: -1 };
    let draggedIdx = -1;

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function initBoard() {
      // é‡ç½®çŠ¶æ€
      moveCount = 0;
      document.getElementById('move-counter').textContent = moveCount;
      document.getElementById('ice-counter').textContent = ICE_COUNT;
      
      // ç”Ÿæˆåˆå§‹æ•°ç»„ (1: å†°å—, 0: ç©ºä½)
      let arr = Array(ICE_COUNT).fill(1).concat(Array(ICE_COUNT).fill(0));
      shuffle(arr);
      
      board = [];
      originalPositions = []; // é‡ç½®åŸå§‹ä½ç½®
      iceBlocksOriginalPos = []; // é‡ç½®å†°å—åŸå§‹ä½ç½®æ•°ç»„
      moved = Array(ICE_COUNT * 2).fill(false);
      
      // æ„å»ºæ¸¸æˆæ¿
      let idx = 0;
      for (let r = 0; r < ROWS; r++) {
        let row = [];
        let posRow = [];
        for (let c = 0; c < COLS; c++) {
          if (idx < arr.length) {
            row.push(arr[idx]);
            // è®°å½•åˆå§‹å†°å—ä½ç½®
            posRow.push(arr[idx] === 1 ? 1 : 0);
            
            // å¦‚æœå½“å‰ä½ç½®æ˜¯å†°å—ï¼Œè®°å½•å®ƒçš„åŸå§‹ä½ç½®
            if (arr[idx] === 1) {
              iceBlocksOriginalPos.push({r, c, idx});
            }
            
            idx++;
          } else {
            row.push(0);
            posRow.push(0);
          }
        }
        board.push(row);
        originalPositions.push(posRow);
      }
    }

    function renderBoard() {
      const boardDiv = document.getElementById('game-board');
      boardDiv.innerHTML = '';
      let idx = 0;
      
      // ç§»é™¤æ‰€æœ‰é«˜äº®
      document.querySelectorAll('.highlight-possible').forEach(el => {
        el.classList.remove('highlight-possible');
      });
      
      // ä¸´æ—¶å‚¨å­˜å†°å—çš„å½“å‰ä½ç½®ä¸ç´¢å¼•æ˜ å°„å…³ç³»
      const currentIcePositions = [];
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (board[r][c] === 1) {
            // æ‰¾åˆ°è¯¥ä½ç½®å†°å—å¯¹åº”çš„ç´¢å¼•
            let foundIdx = -1;
            
            // é¦–å…ˆå°è¯•æ‰¾åˆ°æ˜¯å¦æ˜¯åŸä½ç½®çš„å†°å—
            const originalIdx = iceBlocksOriginalPos.findIndex(pos => pos.r === r && pos.c === c);
            if (originalIdx !== -1 && !moved[iceBlocksOriginalPos[originalIdx].idx]) {
              // åœ¨åŸä½ç½®ä¸”æœªç§»åŠ¨è¿‡
              foundIdx = iceBlocksOriginalPos[originalIdx].idx;
            } else {
              // ä¸æ˜¯åŸä½ç½®æˆ–å·²ç§»åŠ¨è¿‡ï¼Œåˆ™éœ€è¦ä»movedæ•°ç»„ä¸­æŸ¥æ‰¾
              // è¿™é‡Œä¸ä¾èµ–é¡ºåºï¼Œç¡®ä¿æ¯ä¸ªå†°å—çŠ¶æ€éƒ½æ­£ç¡®ä¿å­˜
              for (let i = 0; i < iceBlocksOriginalPos.length; i++) {
                const pos = iceBlocksOriginalPos[i];
                if (moved[pos.idx] && board[pos.r][pos.c] === 0) {
                  // è¿™ä¸ªå†°å—å·²ç»ç§»åŠ¨ï¼Œä½†æˆ‘ä»¬éœ€è¦ç¡®è®¤å®ƒç§»åˆ°äº†å½“å‰ä½ç½®
                  // æ­¤å¤„é€»è¾‘å¯èƒ½éœ€è¦æ›´å¤æ‚çš„åˆ¤æ–­
                  foundIdx = pos.idx;
                  break;
                }
              }
              
              // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨å½“å‰ç´¢å¼•
              if (foundIdx === -1) {
                foundIdx = idx;
              }
            }
            
            currentIcePositions.push({r, c, idx: foundIdx});
          }
          idx++;
        }
      }
      
      // é‡æ–°æ¸²æŸ“æ¸¸æˆæ¿
      idx = 0;
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = r;
          cell.dataset.col = c;
          
          if (board[r][c] === 1) {
            // æ¸²æŸ“å†°å—
            const ice = document.createElement('div');
            
            // è·å–å½“å‰ä½ç½®å†°å—çš„ç´¢å¼•
            const icePosition = currentIcePositions.find(pos => pos.r === r && pos.c === c);
            const currentIdx = icePosition ? icePosition.idx : idx;
            
            // åˆ›å»ºåŸºæœ¬å†°å—
            ice.className = 'ice-block';
            
            // æ£€æŸ¥è¿™ä¸ªç´¢å¼•çš„å†°å—æ˜¯å¦å·²ç»ç§»åŠ¨è¿‡
            // é€šè¿‡ç›´æ¥æŸ¥æ‰¾å†°å—çš„åŸå§‹ä½ç½®æ˜¯å¦ä¸å½“å‰ä½ç½®ä¸åŒï¼Œæˆ–è€…movedæ•°ç»„æ ‡è®°
            const originalPos = iceBlocksOriginalPos.find(pos => pos.idx === currentIdx);
            const isAtOriginalPos = originalPos && originalPos.r === r && originalPos.c === c;
            
            if (moved[currentIdx] || (originalPos && !isAtOriginalPos)) {
              ice.classList.add('moved');
              console.log('æ¸²æŸ“ç§»åŠ¨è¿‡çš„å†°å—:', r, c, currentIdx);
            }
            
            ice.title = moved[currentIdx] ? 'å·²ç§»åŠ¨' : 'å¯ç§»åŠ¨';
            ice.dataset.idx = currentIdx;
            ice.dataset.row = r;
            ice.dataset.col = c;
            ice.draggable = true;
            
            // æ·»åŠ æ‹–æ‹½äº‹ä»¶
            ice.addEventListener('dragstart', (e) => onDragStart(e, r, c, currentIdx));
            ice.addEventListener('dragend', onDragEnd);
            
            // æ·»åŠ è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            ice.addEventListener('touchstart', (e) => onTouchStart(e, r, c, currentIdx));
            ice.addEventListener('touchmove', onTouchMove);
            ice.addEventListener('touchend', onTouchEnd);
            
            // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœï¼Œæ˜¾ç¤ºå¯èƒ½çš„æ»‘è¡Œä½ç½®
            ice.addEventListener('mouseenter', () => {
              showPossibleMoves(r, c);
            });
            
            ice.addEventListener('mouseleave', () => {
              hidePossibleMoves();
            });
            
            cell.appendChild(ice);
          } else {
            // æ¸²æŸ“ç©ºä½æˆ–åŸå§‹ä½ç½®
            const empty = document.createElement('div');
            if (originalPositions[r][c] === 1 && board[r][c] === 0) {
              // è¿™æ˜¯ä¸€ä¸ªåŸå§‹å†°å—ä½ç½®ï¼Œç°åœ¨æ˜¯ç©ºçš„
              empty.className = 'original-position possible-target';
            } else {
              empty.className = 'empty possible-target';
            }
            empty.dataset.row = r;
            empty.dataset.col = c;
            
            // æ·»åŠ æ”¾ç½®åŒºåŸŸäº‹ä»¶
            cell.addEventListener('dragover', allowDrop);
            cell.addEventListener('drop', (e) => onDrop(e, r, c));
            
            cell.appendChild(empty);
          }
          boardDiv.appendChild(cell);
          idx++;
        }
      }
      
      // ä¸ºæ•´ä¸ªæ£‹ç›˜æ·»åŠ è§¦æ‘¸äº‹ä»¶å¤„ç†
      const gameBoard = document.getElementById('game-board');
      gameBoard.addEventListener('touchmove', (e) => {
        if (draggedIce) {
          e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
        }
      }, { passive: false });
    }
    
    // æ‹–æ‹½äº‹ä»¶å¤„ç†
    function onDragStart(e, r, c, idx) {
      draggedIce = e.target;
      dragStartPos = { r, c };
      draggedIdx = idx;
      setTimeout(() => {
        draggedIce.classList.add('dragging');
      }, 0);
      
      // è®¾ç½®æ‹–æ‹½æ•°æ®
      e.dataTransfer.setData('text/plain', `${r},${c},${idx}`);
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function allowDrop(e) {
      e.preventDefault();
    }
    
    function onDrop(e, r, c) {
      e.preventDefault();
      // åªå…è®¸ä¸Šä¸‹å·¦å³ç§»åŠ¨ï¼Œä¸èƒ½æ–œå‘ç§»åŠ¨
      if (isValidMove(dragStartPos.r, dragStartPos.c, r, c)) {
        moveIce(dragStartPos.r, dragStartPos.c, r, c, draggedIdx);
      }
    }
    
    function onDragEnd() {
      if (draggedIce) {
        draggedIce.classList.remove('dragging');
        draggedIce = null;
      }
    }
    
    // è§¦æ‘¸äº‹ä»¶å¤„ç†
    function onTouchStart(e, r, c, idx) {
      const touch = e.touches[0];
      draggedIce = e.target;
      dragStartPos = { r, c };
      draggedIdx = idx;
      
      draggedIce.classList.add('dragging');
      
      // è®°å½•åˆå§‹è§¦æ‘¸ä½ç½®
      draggedIce.dataset.initialX = touch.clientX;
      draggedIce.dataset.initialY = touch.clientY;
      
      e.preventDefault();
    }
    
    function onTouchMove(e) {
      if (!draggedIce) return;
      
      const touch = e.touches[0];
      const initialX = parseInt(draggedIce.dataset.initialX);
      const initialY = parseInt(draggedIce.dataset.initialY);
      
      const currentX = touch.clientX;
      const currentY = touch.clientY;
      
      // è®¡ç®—ç§»åŠ¨è·ç¦»
      const deltaX = currentX - initialX;
      const deltaY = currentY - initialY;
      
      // è®¾ç½®æ‹–åŠ¨å…ƒç´ ä½ç½®
      draggedIce.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.05)`;
      
      e.preventDefault();
    }
    
    function onTouchEnd(e) {
      if (!draggedIce) return;
      
      // è®¡ç®—æœ€ç»ˆä½ç½®
      const rect = draggedIce.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      // æŸ¥æ‰¾å…ƒç´ æ‰€åœ¨ä½ç½®
      const elements = document.elementsFromPoint(centerX, centerY);
      
      let targetCell = null;
      for (const element of elements) {
        if (element.classList.contains('cell')) {
          targetCell = element;
          break;
        }
      }
      
      if (targetCell) {
        const r = parseInt(targetCell.dataset.row);
        const c = parseInt(targetCell.dataset.col);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¯æ»‘è¡Œçš„ç©ºä½
        if (board[r][c] === 0 && isValidMove(dragStartPos.r, dragStartPos.c, r, c)) {
          moveIce(dragStartPos.r, dragStartPos.c, r, c, draggedIdx);
        }
      }
      
      // é‡ç½®æ ·å¼
      draggedIce.style.transform = '';
      draggedIce.classList.remove('dragging');
      draggedIce = null;
      
      e.preventDefault();
    }
    
    function isValidMove(fromR, fromC, toR, toC) {
      // ä»…å…è®¸åŒä¸€è¡Œæˆ–åŒä¸€åˆ—ç§»åŠ¨
      if (!(fromR === toR || fromC === toC)) {
        return false;
      }
      
      // ç¡®ä¿ç›®æ ‡ä½ç½®æ˜¯ç©ºä½
      if (board[toR][toC] !== 0) {
        return false;
      }
      
      // è·å–å†°å—çš„ç´¢å¼•
      const ice = document.querySelector(`.ice-block[data-row="${fromR}"][data-col="${fromC}"]`);
      const iceIdx = parseInt(ice.dataset.idx);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯å·²ç§»åŠ¨çš„å†°å—ï¼ˆç²‰çº¢è‰²ï¼‰
      if (moved[iceIdx]) {
        // å·²ç§»åŠ¨çš„å†°å—åªèƒ½è¿”å›åˆ°å…¶åŸå§‹ä½ç½®
        const originalPos = iceBlocksOriginalPos.find(pos => pos.idx === iceIdx);
        if (!(toR === originalPos.r && toC === originalPos.c)) {
          // å¦‚æœç›®æ ‡ä½ç½®ä¸æ˜¯åŸå§‹ä½ç½®ï¼Œåˆ™ä¸å…è®¸ç§»åŠ¨
          return false;
        }
      }
      
      // ç›´æ¥å…è®¸å†°å—è·¨è¿‡ä»»ä½•å…¶ä»–å†°å—æˆ–ç©ºä½ç§»åŠ¨ï¼Œæ— éœ€æ£€æŸ¥è·¯å¾„ä¸Šçš„éšœç¢ç‰©
      return true;
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šè®¡ç®—å¯èƒ½çš„ç›®æ ‡ä½ç½®
    function findPossibleMoves(r, c) {
      const possibleMoves = [];
      
      // è·å–å†°å—çš„ç´¢å¼•
      const ice = document.querySelector(`.ice-block[data-row="${r}"][data-col="${c}"]`);
      if (!ice) return possibleMoves;
      
      const iceIdx = parseInt(ice.dataset.idx);
      
      // å¦‚æœå†°å—å·²ç»ç§»åŠ¨è¿‡
      if (moved[iceIdx]) {
        // å·²ç§»åŠ¨çš„å†°å—åªèƒ½å›åˆ°åŸä½ç½®
        const originalPos = iceBlocksOriginalPos.find(pos => pos.idx === iceIdx);
        if (originalPos && board[originalPos.r][originalPos.c] === 0) {
          // ç¡®è®¤åŸä½ç½®æ˜¯ç©ºçš„ï¼Œå¹¶ä¸”å¯ä»¥ç›´çº¿æ»‘è¡Œåˆ°é‚£é‡Œ
          if (isValidMove(r, c, originalPos.r, originalPos.c)) {
            possibleMoves.push({r: originalPos.r, c: originalPos.c});
          }
        }
        return possibleMoves;
      }
      
      // å¯¹äºæœªç§»åŠ¨çš„å†°å—ï¼Œæ‰§è¡Œæ­£å¸¸çš„æ»‘è¡Œè§„åˆ™
      
      // å‘ä¸Šæ»‘è¡Œ
      for (let nr = r - 1; nr >= 0; nr--) {
        if (board[nr][c] === 1) break; // é‡åˆ°å¦ä¸€ä¸ªå†°å—åˆ™åœæ­¢
        if (board[nr][c] === 0) {
          possibleMoves.push({r: nr, c});
        }
      }
      
      // å‘ä¸‹æ»‘è¡Œ
      for (let nr = r + 1; nr < ROWS; nr++) {
        if (board[nr][c] === 1) break; // é‡åˆ°å¦ä¸€ä¸ªå†°å—åˆ™åœæ­¢
        if (board[nr][c] === 0) {
          possibleMoves.push({r: nr, c});
        }
      }
      
      // å‘å·¦æ»‘è¡Œ
      for (let nc = c - 1; nc >= 0; nc--) {
        if (board[r][nc] === 1) break; // é‡åˆ°å¦ä¸€ä¸ªå†°å—åˆ™åœæ­¢
        if (board[r][nc] === 0) {
          possibleMoves.push({r, c: nc});
        }
      }
      
      // å‘å³æ»‘è¡Œ
      for (let nc = c + 1; nc < COLS; nc++) {
        if (board[r][nc] === 1) break; // é‡åˆ°å¦ä¸€ä¸ªå†°å—åˆ™åœæ­¢
        if (board[r][nc] === 0) {
          possibleMoves.push({r, c: nc});
        }
      }
      
      return possibleMoves;
    }
    
    // å¼ºåˆ¶åˆ·æ–°å†°å—çŠ¶æ€
    function updateIceBlockStatus(fromR, fromC, toR, toC, idx) {
      console.log('æ›´æ–°å†°å—çŠ¶æ€:', fromR, fromC, 'åˆ°', toR, toC, 'ç´¢å¼•:', idx);
      
      const originalPosition = iceBlocksOriginalPos.find(pos => pos.idx === idx);
      
      if (originalPosition) {
        if (toR === originalPosition.r && toC === originalPosition.c) {
          // å†°å—å›åˆ°åŸä½
          console.log('å†°å—å›åˆ°åŸä½');
          moved[idx] = false;
        } else {
          // å†°å—ç§»åŠ¨åˆ°æ–°ä½ç½®
          console.log('å†°å—ç§»åŠ¨åˆ°æ–°ä½ç½®');
          moved[idx] = true;
        }
      }
      
      // è·å–ç§»åŠ¨åçš„å†°å—å…ƒç´ 
      setTimeout(() => {
        const iceElement = document.querySelector(`.ice-block[data-row="${toR}"][data-col="${toC}"]`);
        if (iceElement) {
          // å¼ºåˆ¶æ›´æ–°ç±»å
          if (moved[idx]) {
            iceElement.classList.add('moved');
            iceElement.title = 'å·²ç§»åŠ¨';
          } else {
            iceElement.classList.remove('moved');
            iceElement.title = 'å¯ç§»åŠ¨';
          }
        }
      }, 50);
    }
    
    function moveIce(fromR, fromC, toR, toC, idx) {
      console.log('ç§»åŠ¨å†°å—:', fromR, fromC, 'åˆ°', toR, toC, 'ç´¢å¼•:', idx);
      
      // äº¤æ¢ä½ç½®
      board[toR][toC] = 1;
      board[fromR][fromC] = 0;
      
      // ç¡®å®šç§»åŠ¨çŠ¶æ€
      const originalPos = iceBlocksOriginalPos.find(pos => pos.idx === idx);
      
      // åˆ¤æ–­æ˜¯å¦æ˜¯è¿”å›åŸä½ç½®çš„ç§»åŠ¨
      if (originalPos && toR === originalPos.r && toC === originalPos.c) {
        // å¦‚æœæ˜¯è¿”å›åŸä½ç½®ï¼Œæ ‡è®°ä¸ºæœªç§»åŠ¨
        console.log('å†°å—å›åˆ°åŸä½ç½®');
        moved[idx] = false;
      } else {
        // å¦åˆ™æ ‡è®°ä¸ºå·²ç§»åŠ¨
        console.log('å†°å—ç§»åŠ¨åˆ°æ–°ä½ç½®');
        moved[idx] = true;
      }
      
      // å¢åŠ ç§»åŠ¨æ­¥æ•°
      moveCount++;
      document.getElementById('move-counter').textContent = moveCount;
      
      // é‡æ–°æ¸²æŸ“æ¸¸æˆæ¿
      renderBoard();
      
      // æ·»åŠ é¢å¤–çš„è§†è§‰åé¦ˆ - ç§»åŠ¨åé«˜äº®å†°å—
      setTimeout(() => {
        const movedIce = document.querySelector(`.ice-block[data-row="${toR}"][data-col="${toC}"]`);
        if (movedIce) {
          // ç¡®ä¿å†°å—æ˜¾ç¤ºæ­£ç¡®çš„æ ·å¼
          if (moved[idx]) {
            movedIce.classList.add('moved');
          } else {
            movedIce.classList.remove('moved');
          }
          
          // æ·»åŠ çŸ­æš‚çš„ç¼©æ”¾æ•ˆæœ
          movedIce.style.transform = 'scale(1.1)';
          setTimeout(() => {
            movedIce.style.transform = '';
          }, 300);
        }
      }, 50);
      
      checkWin();
    }

    function checkWin() {
      // èƒœåˆ©æ¡ä»¶ï¼šæ²¡æœ‰æµ…ç°è‰²ç©ºä½ï¼ˆæ‰€æœ‰éåŸå§‹ä½ç½®çš„ç©ºä½éƒ½è¢«å¡«æ»¡ï¼‰
      let emptyNonOriginalSpaces = 0;
      
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          // å¦‚æœæ˜¯ç©ºä½(0)ä½†ä¸æ˜¯åŸå§‹å†°å—ä½ç½®
          if (board[r][c] === 0 && originalPositions[r][c] === 0) {
            emptyNonOriginalSpaces++;
          }
        }
      }
      
      // å¦‚æœæ²¡æœ‰ç©ºçš„éåŸå§‹ä½ç½®ï¼Œåˆ™èƒœåˆ©
      if (emptyNonOriginalSpaces === 0) {
        showWinModal();
      }
    }
    
    function showWinModal() {
      // æ›´æ–°èƒœåˆ©ä¿¡æ¯
      document.getElementById('win-steps-message').textContent = `ä½ å¤ªæ£’äº†ï¼Œä½ åªç”¨äº†${moveCount}æ­¥ï¼`;
      
      // æ˜¾ç¤ºèƒœåˆ©æ¶ˆæ¯
      document.getElementById('win-message').style.display = 'block';
      
      // æ˜¾ç¤ºå¼¹çª—
      const modal = document.getElementById('win-modal');
      modal.classList.add('active');
      
      // åˆ›å»ºåº†ç¥å½©èŠ±
      createConfetti();
    }
    
    function createConfetti() {
      const container = document.querySelector('.modal-overlay');
      
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        
        // éšæœºä½ç½®ã€é¢œè‰²å’Œå»¶è¿Ÿ
        const left = Math.random() * 100 + 'vw';
        const delay = Math.random() * 3 + 's';
        const colors = ['#aeefff', '#d1b3ff', '#ff9a9e', '#fad0c4', '#a18cd1'];
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        confetti.style.left = left;
        confetti.style.animationDelay = delay;
        confetti.style.backgroundColor = color;
        
        container.appendChild(confetti);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }
    
    // é‡æ–°å¼€å§‹æ¸¸æˆ
    function restartGame() {
      const modal = document.getElementById('win-modal');
      modal.classList.remove('active');
      document.getElementById('win-message').style.display = 'none';
      
      // æ¸…é™¤æ‰€æœ‰å½©èŠ±
      document.querySelectorAll('.confetti').forEach(el => el.remove());
      
      initBoard();
      renderBoard();
    }

    document.getElementById('restart-btn').onclick = restartGame;
    document.getElementById('modal-restart-btn').onclick = restartGame;

    // æ˜¾ç¤ºå¯èƒ½çš„æ»‘è¡Œä½ç½®
    function showPossibleMoves(r, c) {
      hidePossibleMoves(); // å…ˆæ¸…é™¤ä¹‹å‰çš„é«˜äº®
      
      const possibleMoves = findPossibleMoves(r, c);
      possibleMoves.forEach(move => {
        const targetCell = document.querySelector(`.cell[data-row="${move.r}"][data-col="${move.c}"] > div`);
        if (targetCell) {
          targetCell.classList.add('highlight-possible');
        }
      });
    }
    
    // éšè—å¯èƒ½çš„æ»‘è¡Œä½ç½®é«˜äº®
    function hidePossibleMoves() {
      document.querySelectorAll('.highlight-possible').forEach(el => {
        el.classList.remove('highlight-possible');
      });
    }

    // åˆå§‹åŒ–
    initBoard();
    renderBoard();
    
    // æ³¨å†ŒService Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(registration => {
          console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
        }).catch(error => {
          console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
        });
      });
    }
  </script>
</body>
</html> 